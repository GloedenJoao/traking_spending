<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulação e eventos</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <div>
      <h1>Simulação e eventos futuros</h1>
      <p class="muted">Cadastre transações e veja a projeção de fluxo diário.</p>
    </div>
    <nav>
      <a href="/">Visão inicial</a>
      <a href="/simulate" class="active">Simulação e eventos</a>
    </nav>
  </header>
  <div class="container">
    <div class="grid two">
      <div class="card">
        <div class="section-title">
          <h3>Nova transação futura</h3>
          <span class="badge">Crédito ou débito</span>
        </div>
        <form method="post" action="/transactions" class="grid">
          <div class="form-row">
            <div>
              <label>Descrição</label>
              <input type="text" name="description" required>
            </div>
            <div>
              <label>Valor</label>
              <input type="number" step="0.01" name="amount" required>
            </div>
            <div>
              <label>Data</label>
              <input type="date" name="date_value" required>
            </div>
          </div>
          <label>Tipo de transação</label>
          <div class="form-row compact">
            <label class="inline"><input type="radio" name="transaction_type" value="debit" checked> Débito</label>
            <label class="inline"><input type="radio" name="transaction_type" value="credit"> Crédito</label>
          </div>
          <label>Onde ocorrerá?</label>
          <select name="target_type" id="targetType" onchange="toggleAccountSelect(this.value)">
            <option value="account">Conta Corrente / Caixinha</option>
            <option value="credit_card">Cartão de Crédito (aumenta fatura)</option>
            <option value="vale_refeicao">Vale Refeição</option>
            <option value="vale_alimentacao">Vale Alimentação</option>
          </select>
          <div id="accountSelect">
            <label>Escolha a conta</label>
            <select name="account_id">
              {% for acc in accounts %}
              <option value="{{ acc.id }}">{{ acc.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit">Salvar transação</button>
        </form>
      </div>

      <div class="card">
        <div class="section-title">
          <h3>Transferir entre conta corrente e caixinhas</h3>
          <span class="badge">Não vale para vales</span>
        </div>
        <form method="post" action="/transfers" class="grid">
          <div class="form-row">
            <div>
              <label>Descrição</label>
              <input type="text" name="description" required>
            </div>
            <div>
              <label>Valor</label>
              <input type="number" step="0.01" name="amount" required>
            </div>
            <div>
              <label>Data</label>
              <input type="date" name="date_value" required>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Origem</label>
              <select name="from_account_id" required>
                {% for acc in accounts %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label>Destino</label>
              <select name="to_account_id" required>
                {% for acc in accounts %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <button type="submit">Agendar movimentação</button>
        </form>
      </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h3>Eventos futuros considerados</h3>
          <span class="badge">Transações + salário + vales + fatura</span>
        </div>
        <button class="reveal-btn" type="button" onclick="toggleLog()">Mostrar eventos</button>
        <div id="event-log" class="collapsible hidden">
          <table class="table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Origem/Destino</th>
              </tr>
            </thead>
            <tbody>
              {% for evt in event_log %}
              <tr>
                <td>{{ evt[0] }}</td>
                <td>{{ evt[1] }}</td>
                <td class="{{ 'positive' if evt[2] >=0 else 'negative' }}">{{ evt[2]|brl }}</td>
                <td>{{ evt[3] }}</td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="muted">Nenhum evento ainda.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    <div class="card">
      <div class="section-title">
        <h3>Tabela diária</h3>
        <form method="post" action="/simulate/days" style="display:flex; gap:8px; align-items:center;">
          <label>Dias</label>
          <input type="number" name="days" value="{{ days }}" min="15" max="180">
          <button type="submit">Atualizar</button>
        </form>
      </div>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              {% for acc in accounts %}
              <th>{{ acc.name }}</th>
              {% endfor %}
              {% for vale in vales %}
              <th>{{ 'Vale Ref' if vale.vale_type == 'vale_refeicao' else 'Vale Alim' }}</th>
              {% endfor %}
              <th>Cartão (dívida)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr>
              <td>{{ row.date }}</td>
              {% for acc in accounts %}
              {% set balance = row.accounts[acc.id] %}
              <td class="{{ 'positive' if balance >=0 else 'negative' }}">{{ balance|brl }}</td>
              {% endfor %}
              {% set vale_ref = row.vales['vale_refeicao'] %}
              <td class="{{ 'positive' if vale_ref >=0 else 'negative' }}">{{ vale_ref|brl }}</td>
              {% set vale_alim = row.vales['vale_alimentacao'] %}
              <td class="{{ 'positive' if vale_alim >=0 else 'negative' }}">{{ vale_alim|brl }}</td>
              {% set card = row.credit_card %}
              <td class="{{ 'positive' if card >=0 else 'negative' }}">{{ card|brl }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    function toggleAccountSelect(value) {
      const select = document.getElementById('accountSelect');
      select.style.display = value === 'account' ? 'block' : 'none';
    }

    function toggleLog() {
      const log = document.getElementById('event-log');
      log.classList.toggle('hidden');
    }
  </script>
</body>
</html>
