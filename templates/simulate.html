<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulação e eventos</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="page-hero subtle">
    <div>
      <p class="eyebrow">Planejamento</p>
      <h1>Simulação e eventos futuros</h1>
      <p class="muted">Cadastre transações, transfira valores e veja o fluxo projetado.</p>
      <div class="hero-actions">
        <a href="/" class="chip ghost">Visão inicial</a>
        <a href="/simulate" class="chip active">Simulação e eventos</a>
        <a href="/dashboard" class="chip ghost">Dashboard</a>
      </div>
    </div>
  </header>
  <div class="container">
    <div class="grid two">
      <div class="card">
        <div class="section-title">
          <h3>Nova transação futura</h3>
          <span class="badge">Crédito ou débito</span>
        </div>
        <form method="post" action="/transactions" class="grid">
          <div class="form-row">
            <div>
              <label>Descrição</label>
              <input type="text" name="description" required>
            </div>
            <div>
              <label>Valor</label>
              <input type="number" step="0.01" name="amount" required>
            </div>
          </div>
          <div>
            <label>Datas ou períodos</label>
            <div id="txn-date-ranges" class="stacked-rows">
              <div class="form-row" data-range-row>
                <div>
                  <label>Início</label>
                  <input type="date" name="date_start" required>
                </div>
                <div>
                  <label>Fim (opcional)</label>
                  <input type="date" name="date_end">
                </div>
                <button class="secondary" type="button" onclick="removeRange(this, 'txn-date-ranges')">Remover</button>
              </div>
            </div>
            <div class="form-row compact" style="margin-top:8px;">
              <button class="secondary" type="button" onclick="addRange('txn-date-ranges')">Adicionar data/período</button>
              <p class="muted" style="margin:0;">Preencha apenas o início para uma única data ou use início e fim para períodos.</p>
            </div>
          </div>
          <label>Tipo de transação</label>
          <div class="form-row compact">
            <label class="inline"><input type="radio" name="transaction_type" value="debit" checked> Débito</label>
            <label class="inline"><input type="radio" name="transaction_type" value="credit"> Crédito</label>
          </div>
          <label>Onde ocorrerá?</label>
          <select name="target_type" id="targetType" onchange="toggleAccountSelect(this.value)">
            <option value="account">Conta Corrente / Caixinha</option>
            <option value="credit_card">Cartão de Crédito (aumenta fatura)</option>
            <option value="vale_refeicao">Vale Refeição</option>
            <option value="vale_alimentacao">Vale Alimentação</option>
          </select>
          <div id="accountSelect">
            <label>Escolha a conta</label>
            <select name="account_id">
              {% for acc in accounts %}
              <option value="{{ acc.id }}">{{ acc.name }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit">Salvar transação</button>
        </form>
      </div>

      <div class="card">
        <div class="section-title">
          <h3>Transferir entre conta corrente e caixinhas</h3>
          <span class="badge">Não vale para vales</span>
        </div>
        <form method="post" action="/transfers" class="grid">
          <div class="form-row">
            <div>
              <label>Descrição</label>
              <input type="text" name="description" required>
            </div>
            <div>
              <label>Valor</label>
              <input type="number" step="0.01" name="amount" required>
            </div>
          </div>
          <div>
            <label>Datas ou períodos</label>
            <div id="transfer-date-ranges" class="stacked-rows">
              <div class="form-row" data-range-row>
                <div>
                  <label>Início</label>
                  <input type="date" name="date_start" required>
                </div>
                <div>
                  <label>Fim (opcional)</label>
                  <input type="date" name="date_end">
                </div>
                <button class="secondary" type="button" onclick="removeRange(this, 'transfer-date-ranges')">Remover</button>
              </div>
            </div>
            <div class="form-row compact" style="margin-top:8px;">
              <button class="secondary" type="button" onclick="addRange('transfer-date-ranges')">Adicionar data/período</button>
              <p class="muted" style="margin:0;">Permite agendar a mesma transferência em várias datas.</p>
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Origem</label>
              <select name="from_account_id" required>
                {% for acc in accounts %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label>Destino</label>
              <select name="to_account_id" required>
                {% for acc in accounts %}
                <option value="{{ acc.id }}">{{ acc.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <button type="submit">Agendar movimentação</button>
        </form>
      </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h3>Eventos futuros considerados</h3>
          <span class="badge">Transações + salário + vales + fatura</span>
        </div>
        <button class="reveal-btn" type="button" onclick="toggleLog()">Mostrar eventos</button>
        <div id="event-log" class="collapsible hidden">
          <table class="table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Origem/Destino</th>
              </tr>
            </thead>
            <tbody>
              {% for evt in event_log %}
              <tr>
                <td>{{ evt[0] }}</td>
                <td>{{ evt[1] }}</td>
                <td class="{{ 'positive' if evt[2] >=0 else 'negative' }}">{{ evt[2]|brl }}</td>
                <td>{{ evt[3] }}</td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="muted">Nenhum evento ainda.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <h3>Simulações lançadas</h3>
          <span class="badge">Remova itens criados aqui</span>
        </div>
        <button class="reveal-btn" type="button" onclick="toggleSimulations()">Mostrar simulações</button>
        <div id="user-simulations" class="collapsible hidden" style="overflow-x:auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Tipo</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody>
              {% for txn in transactions %}
              <tr>
                <td>{{ txn.date }}</td>
                <td>{{ txn.description }}</td>
                <td class="{{ 'positive' if txn.amount >=0 else 'negative' }}">{{ txn.amount|brl }}</td>
                <td>
                  {% if txn.target_type == 'account' %}
                    Conta: {{ account_lookup.get(txn.account_id, 'Conta corrente/caixinha') }}
                  {% elif txn.target_type == 'credit_card' %}
                    Cartão de crédito
                  {% elif txn.target_type == 'vale_refeicao' %}
                    Vale Refeição
                  {% else %}
                    Vale Alimentação
                  {% endif %}
                </td>
                <td>
                  <form method="post" action="/transactions/{{ txn.id }}/delete">
                    <button class="secondary" type="submit">Remover</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
              {% for mov in transfers %}
              <tr>
                <td>{{ mov.date }}</td>
                <td>{{ mov.description }}</td>
                <td class="negative">{{ (-mov.amount)|brl }}</td>
                <td>Transferência: {{ account_lookup.get(mov.from_account_id, 'Origem') }} → {{ account_lookup.get(mov.to_account_id, 'Destino') }}</td>
                <td>
                  <form method="post" action="/transfers/{{ mov.id }}/delete">
                    <button class="secondary" type="submit">Remover</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
              {% if transactions|length == 0 and transfers|length == 0 %}
              <tr><td colspan="5" class="muted">Nenhuma simulação lançada ainda.</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

    <div class="card">
      <div class="section-title">
        <h3>Tabela diária</h3>
        <form method="post" action="/simulate/days" style="display:flex; gap:8px; align-items:center;">
          <label>Dias</label>
          <input type="number" name="days" value="{{ days }}" min="15" max="180">
          <button type="submit">Atualizar</button>
        </form>
      </div>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead>
            <tr>
              <th>Data</th>
              {% for acc in accounts %}
              <th>{{ acc.name }}</th>
              {% endfor %}
              {% for vale in vales %}
              <th>{{ 'Vale Ref' if vale.vale_type == 'vale_refeicao' else 'Vale Alim' }}</th>
              {% endfor %}
              <th>Cartão (dívida)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr>
              <td>{{ row.date }}</td>
              {% for acc in accounts %}
              {% set balance = row.accounts[acc.id] %}
              <td class="{{ 'positive' if balance >=0 else 'negative' }}">{{ balance|brl }}</td>
              {% endfor %}
              {% set vale_ref = row.vales['vale_refeicao'] %}
              <td class="{{ 'positive' if vale_ref >=0 else 'negative' }}">{{ vale_ref|brl }}</td>
              {% set vale_alim = row.vales['vale_alimentacao'] %}
              <td class="{{ 'positive' if vale_alim >=0 else 'negative' }}">{{ vale_alim|brl }}</td>
              {% set card = row.credit_card %}
              <td class="{{ 'positive' if card >=0 else 'negative' }}">{{ card|brl }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <script>
    function toggleAccountSelect(value) {
      const select = document.getElementById('accountSelect');
      select.style.display = value === 'account' ? 'block' : 'none';
    }

    function toggleLog() {
      const log = document.getElementById('event-log');
      log.classList.toggle('hidden');
    }

    function toggleSimulations() {
      const simulations = document.getElementById('user-simulations');
      simulations.classList.toggle('hidden');
    }

    function addRange(containerId) {
      const container = document.getElementById(containerId);
      const template = container.querySelector('[data-range-row]');
      const clone = template.cloneNode(true);
      clone.querySelectorAll('input').forEach((input) => (input.value = ''));
      container.appendChild(clone);
      updateRemoveButtons(containerId);
    }

    function removeRange(button, containerId) {
      const container = document.getElementById(containerId);
      if (container.querySelectorAll('[data-range-row]').length === 1) {
        return;
      }
      button.closest('[data-range-row]').remove();
      updateRemoveButtons(containerId);
    }

    function updateRemoveButtons(containerId) {
      const container = document.getElementById(containerId);
      const rows = container.querySelectorAll('[data-range-row]');
      rows.forEach((row) => {
        const button = row.querySelector('button');
        button.disabled = rows.length === 1;
      });
    }

    updateRemoveButtons('txn-date-ranges');
    updateRemoveButtons('transfer-date-ranges');
  </script>
</body>
</html>
