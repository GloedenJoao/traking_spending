<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="page-hero subtle">
    <div>
      <p class="eyebrow">Panorama</p>
      <h1>Dashboard</h1>
      <p class="muted">Visualizações diárias com contas, vales, variações e consolidado.</p>
      <div class="hero-actions">
        <a href="/" class="chip ghost">Visão inicial</a>
        <a href="/simulate" class="chip ghost">Simulação e eventos</a>
        <a href="/dashboard" class="chip active">Dashboard</a>
      </div>
    </div>
  </header>
  <div class="container">
    <div class="card filter-bar">
      <div class="section-title">
        <div>
          <p class="eyebrow">Filtros</p>
          <h3>Granularidade diária</h3>
          <p class="muted">Escolha o intervalo e destaque apenas as contas que quer analisar.</p>
        </div>
        <div class="badge">Janela: {{ start_date }} → {{ end_date }}</div>
      </div>
      {% if validation_message %}
        <div class="notice warning">{{ validation_message }}</div>
      {% endif %}
      <form method="get" class="filter-grid">
        <div class="stacked">
          <label for="start_date">Data inicial</label>
          <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
          <p class="hint">Inclui o dia escolhido e segue em frente.</p>
        </div>
        <div class="stacked">
          <label for="end_date">Data final</label>
          <input type="date" id="end_date" name="end_date" min="{{ min_end_date }}" value="{{ end_date }}">
          <p class="hint">Precisa ser maior que hoje. Limitamos a 365 dias a partir do início.</p>
        </div>
        <div class="stacked account-select">
          <div class="select-actions">
            <div>
              <label>Contas exibidas</label>
              <p class="hint"><span class="selected-count">{{ selected_account_ids|length }}</span> selecionada(s) • ajuste no clique</p>
            </div>
            <div class="chip-row">
              <button type="button" class="chip tiny" data-select="all">Selecionar todas</button>
              <button type="button" class="chip tiny ghost" data-select="none">Limpar</button>
            </div>
          </div>
          <div class="account-grid">
            {% for acc in accounts %}
              <label class="select-card {% if acc.id in selected_account_ids %}active{% endif %}">
                <input type="checkbox" name="account_ids" value="{{ acc.id }}" {% if acc.id in selected_account_ids %}checked{% endif %}>
                <div class="select-card__name">{{ acc.name }}</div>
                <div class="select-card__pill">{{ 'Incluída' if acc.id in selected_account_ids else 'Oculta' }}</div>
              </label>
            {% endfor %}
          </div>
        </div>
        <div class="align-end">
          <div class="chip-row">
            <button type="button" class="ghost" onclick="window.location='/dashboard'">Remover filtros</button>
            <button type="submit">Aplicar filtros</button>
          </div>
        </div>
      </form>
    </div>

    <div class="panel-grid">
      <div class="card highlight">
        <p class="eyebrow">Consolidado (sem vales)</p>
        <div class="section-title">
          <h2>Total</h2>
          <div class="chip">Soma das contas + cartão</div>
        </div>
        <div class="big-number">{{ total_summary.latest|brl }}</div>
        <p class="muted">Último dia simulado</p>
        <div class="delta {{ 'positive' if total_summary.delta is not none and total_summary.delta > 0 else 'negative' if total_summary.delta is not none and total_summary.delta < 0 else '' }}">
          {% if total_summary.delta is not none %}
            {{ total_summary.delta|brl }}
            {% if total_summary.delta_pct is not none %}
              (<strong>{{ '%.1f' % total_summary.delta_pct }}%</strong> vs início)
            {% else %}
              (sem comparação)
            {% endif %}
          {% else %}
            Sem comparação com o dia anterior
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <p class="eyebrow">Contas</p>
          <span class="muted">Variação do início ao fim da simulação</span>
        </div>
        <div class="stat-grid">
          {% for card in summary_cards %}
            <div class="insight-card">
              <div class="inline">
                <span class="dot"></span>
                <strong>{{ card.name }}</strong>
              </div>
              <div class="big-number">{{ card.latest|brl }}</div>
              <p class="muted">Saldo do último dia</p>
              <div class="delta {{ 'positive' if card.delta is not none and card.delta > 0 else 'negative' if card.delta is not none and card.delta < 0 else '' }}">
                {% if card.delta is not none %}
                  {{ card.delta|brl }}
                  {% if card.delta_pct is not none %}
                    (<strong>{{ '%.1f' % card.delta_pct }}%</strong>)
                  {% endif %}
                {% else %}
                  Sem variação registrada
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="panel-grid">
      <div class="card highlight">
        <p class="eyebrow">Vales</p>
        <div class="section-title">
          <h2>Total</h2>
          <div class="chip">Refeição + Alimentação</div>
        </div>
        <div class="big-number">{{ vale_total_summary.latest|brl }}</div>
        <p class="muted">Último dia simulado</p>
        <div class="delta {{ 'positive' if vale_total_summary.delta is not none and vale_total_summary.delta > 0 else 'negative' if vale_total_summary.delta is not none and vale_total_summary.delta < 0 else '' }}">
          {% if vale_total_summary.delta is not none %}
            {{ vale_total_summary.delta|brl }}
            {% if vale_total_summary.delta_pct is not none %}
              (<strong>{{ '%.1f' % vale_total_summary.delta_pct }}%</strong> vs início)
            {% else %}
              (sem comparação)
            {% endif %}
          {% else %}
            Sem comparação com o dia anterior
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <p class="eyebrow">Vales</p>
          <span class="muted">Variação do início ao fim da simulação</span>
        </div>
        <div class="stat-grid">
          {% for card in vale_summary_cards %}
            <div class="insight-card">
              <div class="inline">
                <span class="dot"></span>
                <strong>{{ card.name }}</strong>
              </div>
              <div class="big-number">{{ card.latest|brl }}</div>
              <p class="muted">Saldo do último dia</p>
              <div class="delta {{ 'positive' if card.delta is not none and card.delta > 0 else 'negative' if card.delta is not none and card.delta < 0 else '' }}">
                {% if card.delta is not none %}
                  {{ card.delta|brl }}
                  {% if card.delta_pct is not none %}
                    (<strong>{{ '%.1f' % card.delta_pct }}%</strong>)
                  {% endif %}
                {% else %}
                  Sem variação registrada
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="grid charts">
      <div class="card">
        <div class="section-title">
          <div>
            <p class="eyebrow">Faixas diárias</p>
            <h3>Contas ao longo do tempo</h3>
          </div>
          <span class="muted">Inclui contas e Total (sem vales)</span>
        </div>
        <div class="chart-container">
          <canvas id="accountBands"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <div>
            <p class="eyebrow">Variação percentual</p>
            <h3>Total (sem vales)</h3>
          </div>
          <span class="muted">Diferença diária vs início da simulação</span>
        </div>
        <div class="chart-container">
          <canvas id="percentChanges"></canvas>
        </div>
      </div>
    </div>

    <div class="grid charts">
      <div class="card">
        <div class="section-title">
          <div>
            <p class="eyebrow">Faixas diárias</p>
            <h3>Vales ao longo do tempo</h3>
          </div>
          <span class="muted">Inclui vales individuais e total</span>
        </div>
        <div class="chart-container">
          <canvas id="valeBands"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <div>
            <p class="eyebrow">Variação percentual</p>
            <h3>Total de vales</h3>
          </div>
          <span class="muted">Diferença diária vs fim e vs início da simulação</span>
        </div>
        <div class="chart-container">
          <canvas id="valePercentChanges"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const chartData = {{ chart_data | safe }};
    const selectedAccountIds = new Set({{ selected_accounts_json | safe }});

    function formatBRL(value) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
    }

    function pickColor(index) {
      const palette = ['#38bdf8', '#a78bfa', '#f472b6', '#fb7185', '#facc15', '#34d399', '#22d3ee', '#94a3b8'];
      return palette[index % palette.length];
    }

    const accountCtx = document.getElementById('accountBands').getContext('2d');
    const percentCtx = document.getElementById('percentChanges').getContext('2d');
    const valeCtx = document.getElementById('valeBands').getContext('2d');
    const valePercentCtx = document.getElementById('valePercentChanges').getContext('2d');

    function buildAccountDatasets() {
      const datasets = [
        {
          label: 'Total (sem vales)',
          data: chartData.total.values,
          borderColor: '#f59e0b',
          backgroundColor: '#f59e0b33',
          tension: 0.35,
          borderWidth: 2,
          pointRadius: 2,
          fill: false,
        },
      ];

      chartData.accounts
        .filter(acc => selectedAccountIds.has(acc.id))
        .forEach((acc, idx) => {
          datasets.push({
            label: acc.name,
            data: acc.balances,
            fill: true,
            borderColor: pickColor(idx),
            backgroundColor: pickColor(idx) + '33',
            tension: 0.35,
          });
        });

      return datasets;
    }

    function buildPercentDatasets() {
      return [
        {
          label: 'Total vs início',
          data: chartData.total.start_changes,
          borderColor: '#6366f1',
          backgroundColor: '#6366f155',
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3,
          borderDash: [6, 4],
          fill: false,
        }
      ];
    }

    function buildValeDatasets() {
      const datasets = [
        {
          label: 'Total vales',
          data: chartData.vales.total.values,
          borderColor: '#10b981',
          backgroundColor: '#10b98133',
          tension: 0.35,
          borderWidth: 2,
          pointRadius: 2,
          fill: false,
        },
      ];

      chartData.vales.series.forEach((vale, idx) => {
        datasets.push({
          label: vale.name,
          data: vale.balances,
          fill: true,
          borderColor: pickColor(idx + 2),
          backgroundColor: pickColor(idx + 2) + '33',
          tension: 0.35,
        });
      });

      return datasets;
    }

    function buildValePercentDatasets() {
      const datasets = [
        {
          label: 'Vales vs fim',
          data: chartData.vales.total.changes,
          borderColor: '#10b981',
          backgroundColor: '#10b98155',
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3,
          fill: false,
        },
        {
          label: 'Vales vs início',
          data: chartData.vales.total.start_changes,
          borderColor: '#0ea5e9',
          backgroundColor: '#0ea5e955',
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3,
          borderDash: [6, 4],
          fill: false,
        }
      ];

      chartData.vales.series.forEach((vale, idx) => {
        const color = pickColor(idx + 1);
        datasets.push({
          label: `${vale.name} vs fim`,
          data: vale.changes,
          borderColor: color,
          backgroundColor: color + '55',
          tension: 0.3,
          borderWidth: 1.5,
          pointRadius: 3,
          fill: false,
        });

        datasets.push({
          label: `${vale.name} vs início`,
          data: vale.start_changes,
          borderColor: color,
          backgroundColor: color + '33',
          tension: 0.3,
          borderWidth: 1.5,
          pointRadius: 3,
          borderDash: [6, 4],
          fill: false,
        });
      });

      return datasets;
    }

    const accountChart = new Chart(accountCtx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: buildAccountDatasets(),
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const value = ctx.parsed?.y ?? 0;
                return `${ctx.dataset.label}: ${formatBRL(value)}`;
              }
            }
          },
          legend: { position: 'bottom' },
        },
        scales: {
          x: { stacked: false },
          y: {
            stacked: false,
            beginAtZero: true,
            ticks: {
              callback: (value) => formatBRL(value),
            },
          },
        },
      },
    });

    const percentChart = new Chart(percentCtx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: buildPercentDatasets(),
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const value = ctx.parsed?.y ?? 0;
                return `${ctx.dataset.label}: ${value.toFixed(1)}%`;
              },
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (value) => `${value.toFixed(1)}%`,
            },
            title: { display: true, text: 'Variação percentual (linha base em 0%)' },
            grid: {
              color: (ctx) => (ctx.tick.value === 0 ? '#111827' : '#e5e7eb'),
              lineWidth: (ctx) => (ctx.tick.value === 0 ? 2 : 1),
            },
          },
        },
      },
    });

    const valeChart = new Chart(valeCtx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: buildValeDatasets(),
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const value = ctx.parsed?.y ?? 0;
                return `${ctx.dataset.label}: ${formatBRL(value)}`;
              }
            }
          },
          legend: { position: 'bottom' },
        },
        scales: {
          x: { stacked: false },
          y: {
            stacked: false,
            beginAtZero: true,
            ticks: {
              callback: (value) => formatBRL(value),
            },
          },
        },
      },
    });

    const valePercentChart = new Chart(valePercentCtx, {
      type: 'line',
      data: {
        labels: chartData.labels,
        datasets: buildValePercentDatasets(),
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const value = ctx.parsed?.y ?? 0;
                return `${ctx.dataset.label}: ${value.toFixed(1)}%`;
              },
            }
          }
        },
        scales: {
          y: {
            ticks: {
              callback: (value) => `${value.toFixed(1)}%`,
            },
            title: { display: true, text: 'Variação percentual (linha base em 0%)' },
            grid: {
              color: (ctx) => (ctx.tick.value === 0 ? '#111827' : '#e5e7eb'),
              lineWidth: (ctx) => (ctx.tick.value === 0 ? 2 : 1),
            },
          },
        },
      },
    });

    const selectedCountEl = document.querySelector('.selected-count');

    function syncCount() {
      if (selectedCountEl) {
        selectedCountEl.textContent = selectedAccountIds.size;
      }
    }

    function syncCardVisual(input) {
      const card = input.closest('.select-card');
      const pill = card?.querySelector('.select-card__pill');
      if (input.checked) {
        card?.classList.add('active');
        if (pill) pill.textContent = 'Incluída';
      } else {
        card?.classList.remove('active');
        if (pill) pill.textContent = 'Oculta';
      }
    }

    function refreshCharts() {
      accountChart.data.datasets = buildAccountDatasets();
      percentChart.data.datasets = buildPercentDatasets();
      valeChart.data.datasets = buildValeDatasets();
      valePercentChart.data.datasets = buildValePercentDatasets();
      accountChart.update();
      percentChart.update();
      valeChart.update();
      valePercentChart.update();
    }

    const accountInputs = Array.from(document.querySelectorAll('input[name="account_ids"]'));

    accountInputs.forEach((input) => {
      const id = Number(input.value);

      if (input.checked) {
        selectedAccountIds.add(id);
      }

      syncCardVisual(input);

      input.addEventListener('change', (event) => {
        if (event.target.checked) {
          selectedAccountIds.add(id);
        } else {
          selectedAccountIds.delete(id);
        }

        syncCardVisual(input);
        syncCount();
        refreshCharts();
      });
    });

    document.querySelectorAll('button[data-select]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.select;
        accountInputs.forEach((input) => {
          const id = Number(input.value);
          if (mode === 'all') {
            input.checked = true;
            selectedAccountIds.add(id);
          } else {
            input.checked = false;
            selectedAccountIds.delete(id);
          }
          syncCardVisual(input);
        });
        syncCount();
        refreshCharts();
      });
    });

    syncCount();
  </script>
</body>
</html>
